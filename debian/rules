#!/usr/bin/make -f


include /usr/share/quilt/quilt.make


pkg		:= stumpwm
debpkg  	:= $(pkg)

clc-source	:= usr/share/common-lisp/source
clc-systems	:= usr/share/common-lisp/systems
clc-files	:= $(clc-source)/$(pkg)
doc-dir		:= usr/share/doc/$(debpkg)
bin-dir		:= usr/bin


COMMIT_ID	:= $(shell cat debian/commit.id)
DEBIAN_VERSION	:= Debian Git checkout $(COMMIT_ID)

configure: $(QUILT_STAMPFN)
	./autogen.sh
	./configure --with-lisp=clisp \
		--with-ppcre=/usr/share/common-lisp/source/cl-ppcre

build: configure
	sed -e 's/@PACKAGE_VERSION@/${DEBIAN_VERSION}/' version.lisp.in >version.lisp
	$(MAKE) stumpwm.info

clean: unpatch
	dh_testdir
	dh_testroot
	[ ! -f Makefile ] || $(MAKE) clean
	rm -rf autom4te.cache Makefile make-image.lisp version.lisp config.log config.status configure
	dh_clean

install: patch build
	dh_testdir
	dh_testroot
	dh_clean
	dh_installdirs $(clc-files) $(doc-dir)/examples $(bin-dir)
	dh_install $(pkg).asd $(clc-files)
	dh_install *.lisp $(clc-files)
	mv debian/$(debpkg)/$(clc-files)/sample-stumpwmrc.lisp debian/$(debpkg)/$(doc-dir)/examples/
	cp debian/stumpwm.bin debian/$(debpkg)/$(bin-dir)/stumpwm

binary-indep: install
	dh_testdir
	dh_testroot
	dh_installchangelogs
	dh_installdocs README NEWS
	dh_installinfo stumpwm.info
	dh_installman debian/stumpwm.1
	dh_installmenu
	dh_installwm /usr/bin/stumpwm
	dh_lisp
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary-arch:

binary: binary-indep


.PHONY: configure build clean install binary-indep binary-arch binary
